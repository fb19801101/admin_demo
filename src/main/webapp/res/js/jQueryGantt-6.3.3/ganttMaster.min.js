function GanttMaster(){this.tasks=[];this.deletedTaskIds=[];this.links=[];this.editor;this.gantt;this.splitter;this.isMultiRoot=false;this.workSpace;this.element;this.resources;this.roles;this.minEditableDate=0;this.maxEditableDate=Infinity;this.set100OnClose=false;this.shrinkParent=false;this.fillWithEmptyLines=true;this.rowHeight=30;this.minRowsInEditor=30;this.numOfVisibleRows=0;this.firstScreenLine=0;this.rowBufferSize=5;this.firstVisibleTaskIndex=-1;this.lastVisibleTaskIndex=-1;this.baselines={};this.showBaselines=false;this.baselineMillis;this.permissions={canWriteOnParent:true,canWrite:true,canAdd:true,canDelete:true,canInOutdent:true,canMoveUpDown:true,canSeePopEdit:true,canSeeFullEdit:true,canSeeDep:true,canSeeCriticalPath:true,canAddIssue:false,cannotCloseTaskIfIssueOpen:false};this.firstDayOfWeek=Date.firstDayOfWeek;this.serverClientTimeOffset=0;this.currentTask;this.resourceUrl="res/";this.__currentTransaction;this.__undoStack=[];this.__redoStack=[];this.__inUndoRedo=false;Date.workingPeriodResolution=1;var self=this}GanttMaster.prototype.init=function(workSpace){var place=$("<div>").prop("id","TWGanttArea").css({padding:0,"overflow-y":"auto","overflow-x":"hidden","border":"1px solid #e5e5e5",position:"relative"});workSpace.append(place).addClass("TWGanttWorkSpace");this.workSpace=workSpace;this.element=place;this.numOfVisibleRows=Math.ceil(this.element.height()/this.rowHeight);this.element.addClass("colorByStatus");var self=this;$("#gantEditorTemplates").loadTemplates().remove();this.editor=new GridEditor(this);place.append(this.editor.gridified);this.gantt=new Ganttalendar(new Date().getTime()-3600000*24*2,new Date().getTime()+3600000*24*5,this,place.width()*0.6);self.splitter=$.splittify.init(place,this.editor.gridified,this.gantt.element,60);self.splitter.firstBoxMinWidth=5;self.splitter.secondBoxMinWidth=20;var ganttButtons=$.JST.createFromTemplate({},"GANTBUTTONS");place.before(ganttButtons);this.checkButtonPermissions();workSpace.bind("deleteFocused.gantt",function(e){var focusedSVGElement=self.gantt.element.find(".focused.focused.linkGroup");if(focusedSVGElement.size()>0){self.removeLink(focusedSVGElement.data("from"),focusedSVGElement.data("to"))}else{self.deleteCurrentTask()}}).bind("addAboveCurrentTask.gantt",function(){self.addAboveCurrentTask()}).bind("addBelowCurrentTask.gantt",function(){self.addBelowCurrentTask()}).bind("indentCurrentTask.gantt",function(){self.indentCurrentTask()}).bind("outdentCurrentTask.gantt",function(){self.outdentCurrentTask()}).bind("moveUpCurrentTask.gantt",function(){self.moveUpCurrentTask()}).bind("moveDownCurrentTask.gantt",function(){self.moveDownCurrentTask()}).bind("collapseAll.gantt",function(){self.collapseAll()}).bind("expandAll.gantt",function(){self.expandAll()}).bind("fullScreen.gantt",function(){self.fullScreen()}).bind("print.gantt",function(){self.print()}).bind("zoomPlus.gantt",function(){self.gantt.zoomGantt(true)}).bind("zoomMinus.gantt",function(){self.gantt.zoomGantt(false)}).bind("openFullEditor.gantt",function(){self.editor.openFullEditor(self.currentTask,false)}).bind("openAssignmentEditor.gantt",function(){self.editor.openFullEditor(self.currentTask,true)}).bind("addIssue.gantt",function(){self.addIssue()}).bind("openExternalEditor.gantt",function(){self.openExternalEditor()}).bind("undo.gantt",function(){self.undo()}).bind("redo.gantt",function(){self.redo()}).bind("resize.gantt",function(){self.resize()});self.splitter.firstBox.scroll(function(){self.gantt.element.stopTime("test").oneTime(10,"test",function(){var oldFirstRow=self.firstScreenLine;var newFirstRow=Math.floor(self.splitter.firstBox.scrollTop()/self.rowHeight);if(Math.abs(oldFirstRow-newFirstRow)>=self.rowBufferSize){self.firstScreenLine=newFirstRow;self.scrolled(oldFirstRow)}})});$("body").bind("keydown.body",function(e){var eventManaged=true;var isCtrl=e.ctrlKey||e.metaKey;var bodyOrSVG=e.target.nodeName.toLowerCase()=="body"||e.target.nodeName.toLowerCase()=="svg";var inWorkSpace=$(e.target).closest("#TWGanttArea").length>0;var focusedField=$(":focus");var focusedSVGElement=self.gantt.element.find(".focused.focused");var isFocusedSVGElement=focusedSVGElement.length>0;if((inWorkSpace||isFocusedSVGElement)&&isCtrl&&e.keyCode==37){self.outdentCurrentTask();focusedField.focus()}else{if(inWorkSpace&&isCtrl&&e.keyCode==38){self.moveUpCurrentTask();focusedField.focus()}else{if(inWorkSpace&&isCtrl&&e.keyCode==39){self.indentCurrentTask();focusedField.focus()}else{if(inWorkSpace&&isCtrl&&e.keyCode==40){self.moveDownCurrentTask();focusedField.focus()}else{if(isCtrl&&e.keyCode==89){self.redo()}else{if(isCtrl&&e.keyCode==90){self.undo()}else{if((isCtrl&&inWorkSpace)&&(e.keyCode==8||e.keyCode==46)){self.deleteCurrentTask()}else{if(focusedSVGElement.is(".taskBox")&&(e.keyCode==8||e.keyCode==46)){self.deleteCurrentTask()}else{if(focusedSVGElement.is(".linkGroup")&&(e.keyCode==8||e.keyCode==46)){self.removeLink(focusedSVGElement.data("from"),focusedSVGElement.data("to"))}else{eventManaged=false
}}}}}}}}}if(eventManaged){e.preventDefault();e.stopPropagation()}});$("#saveGanttButton").after($("#LOG_CHANGES_CONTAINER"));this.element.on("saveRequired.gantt",this.manageSaveRequired);$(window).resize(function(){place.css({width:"100%",height:$(window).height()-place.position().top});place.trigger("resize.gantt")}).oneTime(2,"resize",function(){$(window).trigger("resize")})};GanttMaster.messages={"CANNOT_WRITE":"CANNOT_WRITE","CHANGE_OUT_OF_SCOPE":"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE","START_IS_MILESTONE":"START_IS_MILESTONE","END_IS_MILESTONE":"END_IS_MILESTONE","TASK_HAS_CONSTRAINTS":"TASK_HAS_CONSTRAINTS","GANTT_ERROR_DEPENDS_ON_OPEN_TASK":"GANTT_ERROR_DEPENDS_ON_OPEN_TASK","GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK":"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK","TASK_HAS_EXTERNAL_DEPS":"TASK_HAS_EXTERNAL_DEPS","GANTT_ERROR_LOADING_DATA_TASK_REMOVED":"GANTT_ERROR_LOADING_DATA_TASK_REMOVED","CIRCULAR_REFERENCE":"CIRCULAR_REFERENCE","CANNOT_MOVE_TASK":"CANNOT_MOVE_TASK","CANNOT_DEPENDS_ON_ANCESTORS":"CANNOT_DEPENDS_ON_ANCESTORS","CANNOT_DEPENDS_ON_DESCENDANTS":"CANNOT_DEPENDS_ON_DESCENDANTS","INVALID_DATE_FORMAT":"INVALID_DATE_FORMAT","GANTT_SEMESTER_SHORT":"GANTT_SEMESTER_SHORT","GANTT_SEMESTER":"GANTT_SEMESTER","GANTT_QUARTER_SHORT":"GANTT_QUARTER_SHORT","GANTT_QUARTER":"GANTT_QUARTER","GANTT_WEEK":"GANTT_WEEK","GANTT_WEEK_SHORT":"GANTT_WEEK_SHORT","CANNOT_CLOSE_TASK_IF_OPEN_ISSUE":"CANNOT_CLOSE_TASK_IF_OPEN_ISSUE","PLEASE_SAVE_PROJECT":"PLEASE_SAVE_PROJECT","CANNOT_CREATE_SAME_LINK":"CANNOT_CREATE_SAME_LINK"};GanttMaster.prototype.createTask=function(id,name,code,level,start,duration){var factory=new TaskFactory();return factory.build(id,name,code,level,start,duration)};GanttMaster.prototype.getOrCreateResource=function(id,name){var res=this.getResource(id);if(!res&&id&&name){res=this.createResource(id,name)}return res};GanttMaster.prototype.createResource=function(id,name){var res=new Resource(id,name);this.resources.push(res);return res};GanttMaster.prototype.updateDependsStrings=function(){for(var i=0;i<this.tasks.length;i++){this.tasks[i].depends=""}for(var i=0;i<this.links.length;i++){var link=this.links[i];var dep=link.to.depends;link.to.depends=link.to.depends+(link.to.depends==""?"":",")+(link.from.getRow()+1)+(link.lag?":"+link.lag:"")}};GanttMaster.prototype.removeLink=function(fromTask,toTask){if(!this.permissions.canWrite||(!fromTask.canWrite&&!toTask.canWrite)){return}this.beginTransaction();var found=false;for(var i=0;i<this.links.length;i++){if(this.links[i].from==fromTask&&this.links[i].to==toTask){this.links.splice(i,1);found=true;break}}if(found){this.updateDependsStrings();if(this.updateLinks(toTask)){this.changeTaskDates(toTask,toTask.start,toTask.end)}}this.endTransaction()};GanttMaster.prototype.removeAllLinks=function(task,openTrans){if(openTrans){this.beginTransaction()}var found=false;for(var i=0;i<this.links.length;i++){if(this.links[i].from==task||this.links[i].to==task){this.links.splice(i,1);found=true}}if(found){this.updateDependsStrings()}if(openTrans){this.endTransaction()}};GanttMaster.prototype.addTask=function(task,row){task.master=this;var pos=-1;for(var i=0;i<this.tasks.length;i++){if(task.id==this.tasks[i].id){pos=i;break}}if(pos>=0){this.tasks.splice(pos,1);row=parseInt(pos)}if(typeof(row)!="number"){this.tasks.push(task)}else{this.tasks.splice(row,0,task);this.updateDependsStrings()}var linkLoops=!this.updateLinks(task);if(task.getParent()){task.status=task.getParent().status}else{task.status="STATUS_ACTIVE"}var ret=task;if(linkLoops||!task.setPeriod(task.start,task.end)){this.tasks.splice(task.getRow(),1);ret=undefined}else{this.editor.addTask(task,row);this.gantt.addTask(task)}$(this.element).trigger("addedTask.gantt",task);return ret};GanttMaster.prototype.loadProject=function(project){this.beginTransaction();this.serverClientTimeOffset=typeof project.serverTimeOffset!="undefined"?(parseInt(project.serverTimeOffset)+new Date().getTimezoneOffset()*60000):0;this.resources=project.resources;this.roles=project.roles;this.permissions.canWrite=project.canWrite;this.permissions.canAdd=project.canAdd;this.permissions.canWriteOnParent=project.canWriteOnParent;this.permissions.cannotCloseTaskIfIssueOpen=project.cannotCloseTaskIfIssueOpen;this.permissions.canAddIssue=project.canAddIssue;this.permissions.canDelete=project.canDelete;this.checkButtonPermissions();if(project.minEditableDate){this.minEditableDate=computeStart(project.minEditableDate)}else{this.minEditableDate=-Infinity}if(project.maxEditableDate){this.maxEditableDate=computeEnd(project.maxEditableDate)}else{this.maxEditableDate=Infinity}var collTasks=this.loadCollapsedTasks();for(var i=0;i<project.tasks.length;i++){var task=project.tasks[i];task.start+=this.serverClientTimeOffset;task.end+=this.serverClientTimeOffset;task.collapsed=collTasks.indexOf(task.id)>=0}this.loadTasks(project.tasks,project.selectedRow);this.deletedTaskIds=[];if(project.zoom){this.gantt.zoom=project.zoom}else{this.gantt.shrinkBoundaries();
  this.gantt.setBestFittingZoom()}this.endTransaction();var self=this;this.gantt.element.oneTime(200,function(){self.gantt.centerOnToday()})};GanttMaster.prototype.loadTasks=function(tasks,selectedRow){var factory=new TaskFactory();this.reset();for(var i=0;i<tasks.length;i++){var task=tasks[i];if(!(task instanceof Task)){var t=factory.build(task.id,task.name,task.code,task.level,task.start,task.duration,task.collapsed);for(var key in task){if(key!="end"&&key!="start"){t[key]=task[key]}}task=t}task.master=this;this.tasks.push(task)}for(var i=0;i<this.tasks.length;i++){var task=this.tasks[i];var numOfError=this.__currentTransaction&&this.__currentTransaction.errors?this.__currentTransaction.errors.length:0;while(!this.updateLinks(task)){if(this.__currentTransaction&&numOfError!=this.__currentTransaction.errors.length){var msg="ERROR:\n";while(numOfError<this.__currentTransaction.errors.length){var err=this.__currentTransaction.errors.pop();msg=msg+err.msg+"\n\n"}alert(msg)}this.removeAllLinks(task,false)}if(!task.setPeriod(task.start,task.end)){alert(GanttMaster.messages.GANNT_ERROR_LOADING_DATA_TASK_REMOVED+"\n"+task.name);this.tasks.splice(task.getRow(),1)}else{this.editor.addTask(task,null,true);this.gantt.addTask(task)}}if(this.tasks&&this.tasks.length>0){selectedRow=selectedRow?selectedRow:0;this.tasks[selectedRow].rowElement.click()}};GanttMaster.prototype.getTask=function(taskId){var ret;for(var i=0;i<this.tasks.length;i++){var tsk=this.tasks[i];if(tsk.id==taskId){ret=tsk;break}}return ret};GanttMaster.prototype.getResource=function(resId){var ret;for(var i=0;i<this.resources.length;i++){var res=this.resources[i];if(res.id==resId){ret=res;break}}return ret};GanttMaster.prototype.changeTaskDeps=function(task){return task.moveTo(task.start,false,true)};GanttMaster.prototype.changeTaskDates=function(task,start,end){return task.setPeriod(start,end)};GanttMaster.prototype.moveTask=function(task,newStart){return task.moveTo(newStart,true,true)};GanttMaster.prototype.taskIsChanged=function(){var master=this;this.element.stopTime("gnnttaskIsChanged");this.element.oneTime(50,"gnnttaskIsChanged",function(){master.redraw();master.element.trigger("gantt.redrawCompleted")})};GanttMaster.prototype.checkButtonPermissions=function(){var ganttButtons=$(".ganttButtonBar");if(!this.permissions.canWrite){ganttButtons.find(".requireCanWrite").hide()}if(!this.permissions.canAdd){ganttButtons.find(".requireCanAdd").hide()}if(!this.permissions.canInOutdent){ganttButtons.find(".requireCanInOutdent").hide()}if(!this.permissions.canMoveUpDown){ganttButtons.find(".requireCanMoveUpDown").hide()}if(!this.permissions.canDelete){ganttButtons.find(".requireCanDelete").hide()}if(!this.permissions.canSeeCriticalPath){ganttButtons.find(".requireCanSeeCriticalPath").hide()}if(!this.permissions.canAddIssue){ganttButtons.find(".requireCanAddIssue").hide()}};GanttMaster.prototype.redraw=function(){this.editor.redraw();this.gantt.redraw()};GanttMaster.prototype.reset=function(){this.tasks=[];this.links=[];this.deletedTaskIds=[];if(!this.__inUndoRedo){this.__undoStack=[];this.__redoStack=[]}else{this.__inUndoRedo=false}delete this.currentTask;this.editor.reset();this.gantt.reset()};GanttMaster.prototype.showTaskEditor=function(taskId){var task=this.getTask(taskId);task.rowElement.find(".edit").click()};GanttMaster.prototype.saveProject=function(){return this.saveGantt(false)};GanttMaster.prototype.saveGantt=function(forTransaction){var saved=[];for(var i=0;i<this.tasks.length;i++){var task=this.tasks[i];var cloned=task.clone();if(!forTransaction){cloned.start-=this.serverClientTimeOffset;cloned.end-=this.serverClientTimeOffset}saved.push(cloned)}var ret={tasks:saved};if(this.currentTask){ret.selectedRow=this.currentTask.getRow()}ret.deletedTaskIds=this.deletedTaskIds;if(!forTransaction){ret.resources=this.resources;ret.roles=this.roles;ret.canAdd=this.permissions.canAdd;ret.canWrite=this.permissions.canWrite;ret.canWriteOnParent=this.permissions.canWriteOnParent;ret.zoom=this.gantt.zoom;this.storeCollapsedTasks();this.markUnChangedTasksAndAssignments(ret);ret.changesReasonWhy=$("#LOG_CHANGES").val()}return ret};GanttMaster.prototype.markUnChangedTasksAndAssignments=function(newProject){if(this.__undoStack.length>0){var oldProject=JSON.parse(this.__undoStack[0]);for(var i=0;i<newProject.tasks.length;i++){var newTask=newProject.tasks[i];if(typeof(newTask.id)=="string"&&!newTask.id.startsWith("tmp_")){var oldTask;for(var j=0;j<oldProject.tasks.length;j++){if(oldProject.tasks[j].id==newTask.id){oldTask=oldProject.tasks[j];break}}var taskChanged=oldTask.id!=newTask.id||oldTask.code!=newTask.code||oldTask.name!=newTask.name||oldTask.start!=newTask.start||oldTask.startIsMilestone!=newTask.startIsMilestone||oldTask.end!=newTask.end||oldTask.endIsMilestone!=newTask.endIsMilestone||oldTask.duration!=newTask.duration||oldTask.status!=newTask.status||oldTask.typeId!=newTask.typeId||oldTask.relevance!=newTask.relevance||oldTask.progress!=newTask.progress||oldTask.progressByWorklog!=newTask.progressByWorklog||oldTask.description!=newTask.description||oldTask.level!=newTask.level||oldTask.depends!=newTask.depends;
  newTask.unchanged=!taskChanged;if(newTask.assigs&&newTask.assigs.length>0){if(oldTask&&oldTask.assigs&&oldTask.assigs.length>0){for(var j=0;j<oldTask.assigs.length;j++){var oldAssig=oldTask.assigs[j];var newAssig;for(var k=0;k<newTask.assigs.length;k++){if(oldAssig.id==newTask.assigs[k].id){newAssig=newTask.assigs[k];break}}if(newAssig){newAssig.unchanged=newAssig.resourceId==oldAssig.resourceId&&newAssig.roleId==oldAssig.roleId&&newAssig.effort==oldAssig.effort}}}}}}}};GanttMaster.prototype.loadCollapsedTasks=function(){var collTasks=[];if(localStorage){if(localStorage.getObject("TWPGanttCollTasks")){collTasks=localStorage.getObject("TWPGanttCollTasks")}return collTasks}};GanttMaster.prototype.storeCollapsedTasks=function(){if(localStorage){var collTasks;if(!localStorage.getObject("TWPGanttCollTasks")){collTasks=[]}else{collTasks=localStorage.getObject("TWPGanttCollTasks")}for(var i=0;i<this.tasks.length;i++){var task=this.tasks[i];var pos=collTasks.indexOf(task.id);if(task.collapsed){if(pos<0){collTasks.push(task.id)}}else{if(pos>=0){collTasks.splice(pos,1)}}}localStorage.setObject("TWPGanttCollTasks",collTasks)}};GanttMaster.prototype.updateLinks=function(task){function isLoop(task,target,visited){if(target==task){return true}var sups=task.getSuperiors();var p=task.getParent();while(p){sups=sups.concat(p.getSuperiors());p=p.getParent()}var chs=task.getChildren();for(var i=0;i<chs.length;i++){sups=sups.concat(chs[i].getSuperiors())}var loop=false;for(var i=0;i<sups.length;i++){var supLink=sups[i];if(supLink.from==target){loop=true;break}else{if(visited.indexOf(supLink.from.id+"x"+target.id)<=0){visited.push(supLink.from.id+"x"+target.id);if(isLoop(supLink.from,target,visited)){loop=true;break}}}}var tpar=target.getParent();if(tpar){if(visited.indexOf(task.id+"x"+tpar.id)<=0){visited.push(task.id+"x"+tpar.id);if(isLoop(task,tpar,visited)){loop=true}}}return loop}this.links=this.links.filter(function(link){return link.to!=task});var todoOk=true;if(task.depends){var parents=task.getParents();var descendants=task.getDescendant();var deps=task.depends.split(",");var newDepsString="";var visited=[];var depsEqualCheck=[];for(var j=0;j<deps.length;j++){var depString=deps[j];var supStr=depString;var lag=0;var pos=depString.indexOf(":");if(pos>0){supStr=depString.substr(0,pos);var lagStr=depString.substr(pos+1);lag=Math.ceil((stringToDuration(lagStr))/Date.workingPeriodResolution)*Date.workingPeriodResolution}var sup=this.tasks[parseInt(supStr)-1];if(sup){if(parents&&parents.indexOf(sup)>=0){this.setErrorOnTransaction('"'+task.name+'"\n'+GanttMaster.messages.CANNOT_DEPENDS_ON_ANCESTORS+'\n"'+sup.name+'"');todoOk=false}else{if(descendants&&descendants.indexOf(sup)>=0){this.setErrorOnTransaction('"'+task.name+'"\n'+GanttMaster.messages.CANNOT_DEPENDS_ON_DESCENDANTS+'\n"'+sup.name+'"');todoOk=false}else{if(isLoop(sup,task,visited)){todoOk=false;this.setErrorOnTransaction(GanttMaster.messages.CIRCULAR_REFERENCE+'\n"'+task.id+" - "+task.name+'" -> "'+sup.id+" - "+sup.name+'"')}else{if(depsEqualCheck.indexOf(sup)>=0){this.setErrorOnTransaction(GanttMaster.messages.CANNOT_CREATE_SAME_LINK+'\n"'+sup.name+'" -> "'+task.name+'"');todoOk=false}else{this.links.push(new Link(sup,task,lag));newDepsString=newDepsString+(newDepsString.length>0?",":"")+supStr+(lag==0?"":":"+durationToString(lag))}}}}if(todoOk){depsEqualCheck.push(sup)}}}task.depends=newDepsString}return todoOk};GanttMaster.prototype.moveUpCurrentTask=function(){var self=this;if(self.currentTask){if(!(self.permissions.canWrite||self.currentTask.canWrite)||!self.permissions.canMoveUpDown){return}self.beginTransaction();self.currentTask.moveUp();self.endTransaction()}};GanttMaster.prototype.moveDownCurrentTask=function(){var self=this;if(self.currentTask){if(!(self.permissions.canWrite||self.currentTask.canWrite)||!self.permissions.canMoveUpDown){return}self.beginTransaction();self.currentTask.moveDown();self.endTransaction()}};GanttMaster.prototype.outdentCurrentTask=function(){var self=this;if(self.currentTask){var par=self.currentTask.getParent();if(!self.currentTask.canWrite||!par.canWrite||!par.getParent()||!par.getParent().canAdd){return}self.beginTransaction();self.currentTask.outdent();self.endTransaction();if(par){self.editor.refreshExpandStatus(par)}}};GanttMaster.prototype.indentCurrentTask=function(){var self=this;if(self.currentTask){var row=self.currentTask.getRow();if(!self.currentTask.canWrite||row<=0||!self.tasks[row-1].canAdd){return}self.beginTransaction();self.currentTask.indent();self.endTransaction()}};GanttMaster.prototype.addBelowCurrentTask=function(){var self=this;var factory=new TaskFactory();var ch;var row=0;if(self.currentTask&&self.currentTask.name){var addNewBrother=!(self.currentTask.isParent()||self.currentTask.level==0);var canAddChild=self.currentTask.canAdd;var canAddBrother=self.currentTask.getParent()&&self.currentTask.getParent().canAdd;addNewBrother=addNewBrother&&canAddBrother;if(!canAddBrother&&!canAddChild){return}ch=factory.build("tmp_"+new Date().getTime(),"","",self.currentTask.level+(addNewBrother?0:1),self.currentTask.start,1);
  row=self.currentTask.getRow()+1;if(row>0){self.beginTransaction();var task=self.addTask(ch,row);if(task){task.rowElement.click();task.rowElement.find("[name=name]").focus()}self.endTransaction()}}};GanttMaster.prototype.addAboveCurrentTask=function(){var self=this;if((self.currentTask.getParent()&&!self.currentTask.getParent().canAdd)){return}var factory=new TaskFactory();var ch;var row=0;if(self.currentTask&&self.currentTask.name){if(self.currentTask.level<=0){return}ch=factory.build("tmp_"+new Date().getTime(),"","",self.currentTask.level,self.currentTask.start,1);row=self.currentTask.getRow();if(row>0){self.beginTransaction();var task=self.addTask(ch,row);if(task){task.rowElement.click();task.rowElement.find("[name=name]").focus()}self.endTransaction()}}};GanttMaster.prototype.deleteCurrentTask=function(taskId){var self=this;var task;if(taskId){task=self.getTask(taskId)}else{task=self.currentTask}if(!task||!self.permissions.canDelete&&!task.canDelete){return}var taskIsEmpty=task.name=="";var row=task.getRow();if(task&&(row>0||self.isMultiRoot||task.isNew())){var par=task.getParent();self.beginTransaction();task.deleteTask();task=undefined;self.updateDependsStrings();self.taskIsChanged();if(par){self.editor.refreshExpandStatus(par)}row=row>self.tasks.length-1?self.tasks.length-1:row;if(!taskIsEmpty&&row>=0){task=self.tasks[row];task.rowElement.click();task.rowElement.find("[name=name]").focus()}self.endTransaction()}};GanttMaster.prototype.collapseAll=function(){if(this.currentTask){this.currentTask.collapsed=true;var desc=this.currentTask.getDescendant();for(var i=0;i<desc.length;i++){if(desc[i].isParent()){desc[i].collapsed=true}desc[i].rowElement.hide()}this.redraw();this.storeCollapsedTasks()}};GanttMaster.prototype.fullScreen=function(){this.workSpace.toggleClass("ganttFullScreen").resize();$("#fullscrbtn .teamworkIcon").html(this.workSpace.is(".ganttFullScreen")?"â‚¬":"@")};GanttMaster.prototype.expandAll=function(){if(this.currentTask){this.currentTask.collapsed=false;var desc=this.currentTask.getDescendant();for(var i=0;i<desc.length;i++){desc[i].collapsed=false;desc[i].rowElement.show()}this.redraw();this.storeCollapsedTasks()}};GanttMaster.prototype.collapse=function(task,all){task.collapsed=true;task.rowElement.addClass("collapsed");var descs=task.getDescendant();for(var i=0;i<descs.length;i++){descs[i].rowElement.hide()}this.redraw();this.storeCollapsedTasks()};GanttMaster.prototype.expand=function(task,all){task.collapsed=false;task.rowElement.removeClass("collapsed");var collapsedDescendant=this.getCollapsedDescendant();var descs=task.getDescendant();for(var i=0;i<descs.length;i++){var childTask=descs[i];if(collapsedDescendant.indexOf(childTask)>=0){continue}childTask.rowElement.show()}this.redraw();this.storeCollapsedTasks()};GanttMaster.prototype.getCollapsedDescendant=function(){var allTasks=this.tasks;var collapsedDescendant=[];for(var i=0;i<allTasks.length;i++){var task=allTasks[i];if(collapsedDescendant.indexOf(task)>=0){continue}if(task.collapsed){collapsedDescendant=collapsedDescendant.concat(task.getDescendant())}}return collapsedDescendant};GanttMaster.prototype.addIssue=function(){var self=this;if(self.currentTask&&self.currentTask.isNew()){alert(GanttMaster.messages.PLEASE_SAVE_PROJECT);return}if(!self.currentTask||!self.currentTask.canAddIssue){return}openIssueEditorInBlack("0","AD","ISSUE_TASK="+self.currentTask.id)};GanttMaster.prototype.openExternalEditor=function(){var self=this;if(!self.currentTask){return}if(self.currentTask.isNew()){alert(GanttMaster.messages.PLEASE_SAVE_PROJECT)}};GanttMaster.prototype.beginTransaction=function(){if(!this.__currentTransaction){this.__currentTransaction={snapshot:JSON.stringify(this.saveGantt(true)),errors:[]}}else{console.error("Cannot open twice a transaction")}return this.__currentTransaction};GanttMaster.prototype.setErrorOnTransaction=function(errorMessage,task){if(this.__currentTransaction){this.__currentTransaction.errors.push({msg:errorMessage,task:task})}else{console.error(errorMessage)}};GanttMaster.prototype.isTransactionInError=function(){if(!this.__currentTransaction){console.error("Transaction never started.");return true}else{return this.__currentTransaction.errors.length>0}};GanttMaster.prototype.endTransaction=function(){if(!this.__currentTransaction){console.error("Transaction never started.");return true}var ret=true;if(this.__currentTransaction.errors.length<=0){this.__undoStack.push(this.__currentTransaction.snapshot);this.__redoStack=[];this.gantt.shrinkBoundaries();this.taskIsChanged()}else{ret=false;var msg="ERROR:\n";for(var i=0;i<this.__currentTransaction.errors.length;i++){var err=this.__currentTransaction.errors[i];msg=msg+err.msg+"\n\n"}alert(msg);var oldTasks=JSON.parse(this.__currentTransaction.snapshot);this.deletedTaskIds=oldTasks.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(oldTasks.tasks,oldTasks.selectedRow);this.redraw()}this.__currentTransaction=undefined;this.saveRequired();this.editor.refreshExpandStatus(this.currentTask);
  return ret};GanttMaster.prototype.checkpoint=function(){this.__undoStack=[];this.__redoStack=[];this.saveRequired()};GanttMaster.prototype.undo=function(){if(this.__undoStack.length>0){var his=this.__undoStack.pop();this.__redoStack.push(JSON.stringify(this.saveGantt()));var oldTasks=JSON.parse(his);this.deletedTaskIds=oldTasks.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(oldTasks.tasks,oldTasks.selectedRow);this.redraw();this.saveRequired()}};GanttMaster.prototype.redo=function(){if(this.__redoStack.length>0){var his=this.__redoStack.pop();this.__undoStack.push(JSON.stringify(this.saveGantt()));var oldTasks=JSON.parse(his);this.deletedTaskIds=oldTasks.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(oldTasks.tasks,oldTasks.selectedRow);this.redraw();this.saveRequired()}};GanttMaster.prototype.saveRequired=function(){if(this.__undoStack.length>0){$("#saveGanttButton").removeClass("disabled");$("form[alertOnChange] #Gantt").val(new Date().getTime());this.element.trigger("saveRequired.gantt",[true])}else{$("#saveGanttButton").addClass("disabled");$("form[alertOnChange] #Gantt").updateOldValue();this.element.trigger("saveRequired.gantt",[false])}};GanttMaster.prototype.print=function(){this.gantt.redrawTasks(true);print()};GanttMaster.prototype.resize=function(){var self=this;this.element.stopTime("resizeRedraw").oneTime(50,"resizeRedraw",function(){self.splitter.resize();self.numOfVisibleRows=Math.ceil(self.element.height()/self.rowHeight);self.firstScreenLine=Math.floor(self.splitter.firstBox.scrollTop()/self.rowHeight);self.gantt.redrawTasks()})};GanttMaster.prototype.scrolled=function(oldFirstRow){var self=this;var newFirstRow=self.firstScreenLine;if(newFirstRow!=oldFirstRow){var collapsedDescendant=self.getCollapsedDescendant();var scrollDown=newFirstRow>oldFirstRow;var startRowDel;var endRowDel;var startRowAdd;var endRowAdd;if(scrollDown){startRowDel=oldFirstRow-self.rowBufferSize;endRowDel=newFirstRow-self.rowBufferSize;startRowAdd=Math.max(oldFirstRow+self.numOfVisibleRows+self.rowBufferSize,endRowDel);endRowAdd=newFirstRow+self.numOfVisibleRows+self.rowBufferSize}else{startRowDel=newFirstRow+self.numOfVisibleRows+self.rowBufferSize;endRowDel=oldFirstRow+self.numOfVisibleRows+self.rowBufferSize;startRowAdd=newFirstRow-self.rowBufferSize;endRowAdd=Math.min(oldFirstRow-self.rowBufferSize,startRowDel)}var firstVisibleRow=newFirstRow-self.rowBufferSize;var lastVisibleRow=newFirstRow+self.numOfVisibleRows+self.rowBufferSize;var row=0;self.firstVisibleTaskIndex=-1;for(var i=0;i<self.tasks.length;i++){var task=self.tasks[i];if(collapsedDescendant.indexOf(task)>=0){continue}if(row>=startRowDel&&row<endRowDel){if(task.ganttElement){task.ganttElement.remove()}if(task.ganttBaselineElement){task.ganttBaselineElement.remove()}}else{if(row>=startRowAdd&&row<endRowAdd){self.gantt.drawTask(task)}}if(row>=firstVisibleRow&&row<lastVisibleRow){self.firstVisibleTaskIndex=self.firstVisibleTaskIndex==-1?i:self.firstVisibleTaskIndex;self.lastVisibleTaskIndex=i}row++}}};GanttMaster.prototype.computeCriticalPath=function(){if(!this.tasks){return false}var tasks=this.tasks.filter(function(t){return(t.getRow()>0)&&(!t.isParent()||(t.isParent()&&!t.isDependent()))});for(var i=0;i<tasks.length;i++){var t=tasks[i];t.earlyStart=-1;t.earlyFinish=-1;t.latestStart=-1;t.latestFinish=-1;t.criticalCost=-1;t.isCritical=false}var completed=[];var remaining=tasks.concat();while(remaining.length>0){var progress=false;for(var i=0;i<remaining.length;i++){var task=remaining[i];var inferiorTasks=task.getInferiorTasks();if(containsAll(completed,inferiorTasks)){var critical=0;for(var j=0;j<inferiorTasks.length;j++){var t=inferiorTasks[j];if(t.criticalCost>critical){critical=t.criticalCost}}task.criticalCost=critical+task.duration;completed.push(task);remaining.splice(i,1);progress=true}}if(!progress){console.error("Cyclic dependency, algorithm stopped!");return false}}computeMaxCost(tasks);var initialNodes=initials(tasks);calculateEarly(initialNodes);calculateCritical(tasks);return tasks;function containsAll(set,targets){for(var i=0;i<targets.length;i++){if(set.indexOf(targets[i])<0){return false}}return true}function computeMaxCost(tasks){var max=-1;for(var i=0;i<tasks.length;i++){var t=tasks[i];if(t.criticalCost>max){max=t.criticalCost}}for(var i=0;i<tasks.length;i++){var t=tasks[i];t.setLatest(max)}}function initials(tasks){var initials=[];for(var i=0;i<tasks.length;i++){if(!tasks[i].depends||tasks[i].depends==""){initials.push(tasks[i])}}return initials}function calculateEarly(initials){for(var i=0;i<initials.length;i++){var initial=initials[i];initial.earlyStart=0;initial.earlyFinish=initial.duration;setEarly(initial)}}function setEarly(initial){var completionTime=initial.earlyFinish;var inferiorTasks=initial.getInferiorTasks();for(var i=0;i<inferiorTasks.length;i++){var t=inferiorTasks[i];if(completionTime>=t.earlyStart){t.earlyStart=completionTime;t.earlyFinish=completionTime+t.duration}setEarly(t)}}function calculateCritical(tasks){for(var i=0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     i<tasks.length;i++){var t=tasks[i];t.isCritical=(t.earlyStart==t.latestStart)}}};GanttMaster.prototype.manageSaveRequired=function(ev,showSave){var self=this;function checkChanges(){var changes=false;if(self.__undoStack.length>0){var oldProject=JSON.parse(self.__undoStack[0]);for(var i=0;!changes&&i<self.tasks.length;i++){var newTask=self.tasks[i];if(!(""+newTask.id).startsWith("tmp_")){var oldTask;for(var j=0;j<oldProject.tasks.length;j++){if(oldProject.tasks[j].id==newTask.id){oldTask=oldProject.tasks[j];break}}if(oldTask&&(oldTask.status!=newTask.status||oldTask.start!=newTask.start||oldTask.end!=newTask.end)){changes=true;break}}}}$("#LOG_CHANGES_CONTAINER").css("display",changes?"inline-block":"none")}if(showSave){$("body").stopTime("gantt.manageSaveRequired").oneTime(200,"gantt.manageSaveRequired",checkChanges)}else{$("#LOG_CHANGES_CONTAINER").hide()}};GanttMaster.prototype.setHoursOn=function(startWorkingHour,endWorkingHour,dateFormat,resolution){Date.defaultFormat=dateFormat;Date.startWorkingHour=startWorkingHour;Date.endWorkingHour=endWorkingHour;Date.useMillis=resolution>=1000;Date.workingPeriodResolution=resolution;millisInWorkingDay=endWorkingHour-startWorkingHour};GanttMaster.prototype.levelCode=function(){if(this.tasks&&this.tasks.length>0){var curCodeExt=1;for(var i=0;i<this.tasks.length;i++){var tsk=this.tasks[i];if(tsk.level==0){tsk.code=curCodeExt;levelChildCode(tsk.getChildren(),tsk.code);curCodeExt++}}}function levelChildCode(cTasks,prefix){if(cTasks&&cTasks.length>0){var curCodeExt=1;for(var i=0;i<cTasks.length;i++){var tsk=cTasks[i];tsk.code=prefix+"."+curCodeExt;levelChildCode(tsk.getChildren(),tsk.code);curCodeExt++}}}};GanttMaster.prototype.browserTaskBar=function(task){if(task&&task instanceof Task){var id=task.id;var taskBar=$('svg[taskid="'+id+'"]');var $taskBar=$(taskBar);if($taskBar.length==0){return}var taskBarX=parseFloat($taskBar[0].getAttribute("x"));var taskBarWidth=parseFloat($taskBar[0].getBoundingClientRect().width);var canvas=$taskBar.parent().parent().parent();var canvasWidth=parseFloat($(canvas).width());var scroll=$taskBar.parent().parent().parent().parent();var scrollWidth=parseFloat($(scroll).width());var centerLeft=(taskBarX+taskBarWidth/2);var scrollLeft=(centerLeft-scrollWidth/2);var oldScrollLeft=$(scroll).scrollLeft();if(Math.abs(oldScrollLeft-scrollLeft)>=1){$(scroll).scrollLeft(scrollLeft)}}};