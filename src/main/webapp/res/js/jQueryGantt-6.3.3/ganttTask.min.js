function TaskFactory(){this.build=function(id,name,code,level,start,duration,collapsed){var adjusted_start=computeStart(start);var calculated_end=computeEndByDuration(adjusted_start,duration);return new Task(id,name,code,level,adjusted_start,calculated_end,duration,collapsed)}}function Task(id,name,code,level,start,end,duration,collapsed){this.id=id;this.name=name;this.progress=0;this.progressByWorklog=false;this.relevance=0;this.type="";this.typeId="";this.description="";this.code=code;this.level=level;this.status="STATUS_UNDEFINED";this.depends="";this.start=start;this.duration=duration;this.end=end;this.startIsMilestone=false;this.endIsMilestone=false;this.collapsed=collapsed;this.canWrite=true;this.canAdd=true;this.canDelete=true;this.canAddIssue=true;this.rowElement;this.ganttElement;this.master;this.assigs=[]}Task.prototype.clone=function(){var ret={};for(var key in this){if(typeof(this[key])!="function"){if(typeof(this[key])!="object"||Array.isArray(this[key])){ret[key]=this[key]}}}return ret};Task.prototype.getAssigsString=function(){var ret="";for(var i=0;i<this.assigs.length;i++){var ass=this.assigs[i];var res=this.master.getResource(ass.resourceId);if(res){ret=ret+(ret==""?"":", ")+res.name}}return ret};Task.prototype.createAssignment=function(id,resourceId,roleId,effort){var assig=new Assignment(id,resourceId,roleId,effort);this.assigs.push(assig);return assig};Task.prototype.setPeriod=function(start,end){if(start instanceof Date){start=start.getTime()}if(end instanceof Date){end=end.getTime()}var originalPeriod={start:this.start,end:this.end,duration:this.duration};start=computeStart(start);end=computeEnd(end);var newDuration=recomputeDuration(start,end);if(start==originalPeriod.start&&end==originalPeriod.end&&newDuration==originalPeriod.duration){return true}if(newDuration==this.duration){return this.moveTo(start,false,true)}var wantedStartMillis=start;var children=this.getChildren();if(this.master.shrinkParent&&children.length>0){var chPeriod=this.getChildrenBoudaries();start=chPeriod.start;end=chPeriod.end}if(start>end){start=end}var startBySuperiors=this.computeStartBySuperiors(start);if(startBySuperiors!=start){return this.moveTo(startBySuperiors,false,true)}var somethingChanged=false;if(this.start!=start||this.start!=wantedStartMillis){this.start=start;somethingChanged=true}var wantedEndMillis=end;if(this.end!=end||this.end!=wantedEndMillis){this.end=end;somethingChanged=true}this.duration=recomputeDuration(this.start,this.end);if(!somethingChanged){return true}if(!this.canWrite){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["CANNOT_WRITE"],this);return false}if(this.hasExternalDep){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["TASK_HAS_EXTERNAL_DEPS"],this);return false}var todoOk=true;var deltaPeriod=originalPeriod.duration-this.duration;var restricting=deltaPeriod>0;var enlarging=deltaPeriod<0;var restrictingStart=restricting&&(originalPeriod.start<this.start);var restrictingEnd=restricting&&(originalPeriod.end>this.end);if(restricting){var bs=Infinity;var be=0;for(var i=0;i<children.length;i++){var ch=children[i];if(restrictingEnd){be=Math.max(be,ch.end)}else{bs=Math.min(bs,ch.start)}}if(restrictingEnd){this.end=Math.max(be,this.end)}else{this.start=Math.min(bs,this.start)}this.duration=recomputeDuration(this.start,this.end);if(this.master.shrinkParent){todoOk=updateTree(this)}}else{if(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["CHANGE_OUT_OF_SCOPE"],this);todoOk=false}if(todoOk){todoOk=updateTree(this)}}if(todoOk){todoOk=this.propagateToInferiors(end)}return todoOk};Task.prototype.moveTo=function(start,ignoreMilestones,propagateToInferiors){if(start instanceof Date){start=start.getTime()}var originalPeriod={start:this.start,end:this.end};var wantedStartMillis=start;start=computeStart(start);start=this.computeStartBySuperiors(start);var end=computeEndByDuration(start,this.duration);if(!this.checkMilestonesConstraints(start,end,ignoreMilestones)){return false}if(this.start!=start||this.start!=wantedStartMillis){this.start=start;this.end=end;if(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["CHANGE_OUT_OF_SCOPE"],this);return false}var panDeltaInWM=getDistanceInUnits(new Date(originalPeriod.start),new Date(this.start));var children=this.getChildren();for(var i=0;i<children.length;i++){var ch=children[i];var chStart=incrementDateByUnits(new Date(ch.start),panDeltaInWM);ch.moveTo(chStart,false,false)}if(!updateTree(this)){return false}if(propagateToInferiors){this.propagateToInferiors(end);var todoOk=true;var descendants=this.getDescendant();for(var i=0;i<descendants.length;i++){ch=descendants[i];if(!ch.propagateToInferiors(ch.end)){return false}}}}return true};Task.prototype.checkMilestonesConstraints=function(newStart,newEnd,ignoreMilestones){if(!ignoreMilestones&&(this.startIsMilestone&&newStart!=this.start)){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["START_IS_MILESTONE"],this);
  return false}else{if(!ignoreMilestones&&(this.endIsMilestone&&newEnd!=this.end)){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["END_IS_MILESTONE"],this);return false}else{if(this.hasExternalDep){this.master.setErrorOnTransaction('"'+this.name+'"\n'+GanttMaster.messages["TASK_HAS_EXTERNAL_DEPS"],this);return false}}}return true};Task.prototype.propagateToInferiors=function(end){var todoOk=true;var infs=this.getInferiors();if(infs&&infs.length>0){for(var i=0;i<infs.length;i++){var link=infs[i];if(!link.to.canWrite){this.master.setErrorOnTransaction(GanttMaster.messages["CANNOT_WRITE"]+'\n"'+link.to.name+'"',link.to);break}todoOk=link.to.moveTo(end,false,true);if(!todoOk){break}}}return todoOk};Task.prototype.computeStartBySuperiors=function(proposedStart){var supEnd=proposedStart;var sups=this.getSuperiors();if(sups&&sups.length>0){supEnd=0;for(var i=0;i<sups.length;i++){var link=sups[i];supEnd=Math.max(supEnd,incrementDateByUnits(new Date(link.from.end),link.lag))}supEnd+=1}return computeStart(supEnd)};function updateTree(task){var error;var p=task.getParent();if(!p){return true}var newStart;var newEnd;if(task.master.shrinkParent){var chPeriod=p.getChildrenBoudaries();newStart=chPeriod.start;newEnd=chPeriod.end}else{newStart=p.start;newEnd=p.end;if(p.start>task.start){newStart=task.start}if(p.end<task.end){newEnd=task.end}}if(p.start!=newStart){if(p.startIsMilestone){task.master.setErrorOnTransaction('"'+p.name+'"\n'+GanttMaster.messages["START_IS_MILESTONE"],task);return false}else{if(p.depends){task.master.setErrorOnTransaction('"'+p.name+'"\n'+GanttMaster.messages["TASK_HAS_CONSTRAINTS"],task);return false}}}if(p.end!=newEnd){if(p.endIsMilestone){task.master.setErrorOnTransaction('"'+p.name+'"\n'+GanttMaster.messages["END_IS_MILESTONE"],task);return false}}if(newStart!=p.start||newEnd!=p.end){if(!p.canWrite){task.master.setErrorOnTransaction(GanttMaster.messages["CANNOT_WRITE"]+"\n"+p.name,task);return false}if(p.hasExternalDep){task.master.setErrorOnTransaction(GanttMaster.messages["TASK_HAS_EXTERNAL_DEPS"]+'\n"'+p.name+'"',task);return false}return p.setPeriod(newStart,newEnd)}return true}Task.prototype.getChildrenBoudaries=function(){var newStart=Infinity;var newEnd=-Infinity;var children=this.getChildren();for(var i=0;i<children.length;i++){var ch=children[i];newStart=Math.min(newStart,ch.start);newEnd=Math.max(newEnd,ch.end)}return({start:newStart,end:newEnd})};Task.prototype.changeStatus=function(newStatus,forceStatusCheck){var cone=this.getDescendant();function propagateStatus(task,newStatus,manuallyChanged,propagateFromParent,propagateFromChildren){var oldStatus=task.status;if(newStatus==oldStatus&&!forceStatusCheck){return true}var todoOk=true;task.status=newStatus;if(newStatus=="STATUS_DONE"){if(task.master.permissions.cannotCloseTaskIfIssueOpen&&task.openIssues>0){task.master.setErrorOnTransaction(GanttMaster.messages["CANNOT_CLOSE_TASK_IF_OPEN_ISSUE"]+' "'+task.name+'"');return false}if((manuallyChanged||oldStatus!="STATUS_FAILED")){var sups=task.getSuperiors();for(var i=0;i<sups.length;i++){if(sups[i].from.status!="STATUS_DONE"&&cone.indexOf(sups[i].from)<0){if(manuallyChanged||propagateFromParent){task.master.setErrorOnTransaction(GanttMaster.messages["GANTT_ERROR_DEPENDS_ON_OPEN_TASK"]+'\n"'+sups[i].from.name+'" -> "'+task.name+'"')}todoOk=false;break}}if(todoOk){if(task.master.set100OnClose&&!task.progressByWorklog){task.progress=100}propagateStatusToChildren(task,newStatus,false);propagateStatusToInferiors(task.getInferiors(),"STATUS_ACTIVE")}}else{todoOk=false}}else{if(newStatus=="STATUS_ACTIVE"){if(manuallyChanged||(oldStatus!="STATUS_FAILED"&&oldStatus!="STATUS_SUSPENDED")){var sups=task.getSuperiors();for(var i=0;i<sups.length;i++){if(sups[i].from.status!="STATUS_DONE"){if(manuallyChanged||propagateFromChildren){task.master.setErrorOnTransaction(GanttMaster.messages["GANTT_ERROR_DEPENDS_ON_OPEN_TASK"]+'\n"'+sups[i].from.name+'" -> "'+task.name+'"')}todoOk=false;break}}if(todoOk){var par=task.getParent();if(par&&par.status!="STATUS_ACTIVE"){todoOk=false}}if(todoOk){if(oldStatus=="STATUS_UNDEFINED"||oldStatus=="STATUS_SUSPENDED"||oldStatus=="STATUS_WAITING"){propagateStatusToChildren(task,newStatus,true)}propagateStatusToInferiors(task.getInferiors(),"STATUS_WAITING")}}else{todoOk=false}}else{if(newStatus=="STATUS_WAITING"){if(manuallyChanged||oldStatus!="STATUS_FAILED"){var par=task.getParent();if(par&&(par.status!="STATUS_ACTIVE"&&par.status!="STATUS_SUSPENDED"&&par.status!="STATUS_WAITING")){todoOk=false}if(todoOk){propagateStatusToChildren(task,"STATUS_WAITING",true);propagateStatusToInferiors(task.getInferiors(),"STATUS_WAITING")}}else{todoOk=false}}else{if(newStatus=="STATUS_SUSPENDED"){if(manuallyChanged||oldStatus!="STATUS_FAILED"){var par=task.getParent();if(par&&(par.status!="STATUS_ACTIVE"&&par.status!="STATUS_SUSPENDED"&&par.status!="STATUS_WAITING")){todoOk=false}if(todoOk){propagateStatusToChildren(task,"STATUS_SUSPENDED",true);propagateStatusToInferiors(task.getInferiors(),"STATUS_SUSPENDED")
}}else{todoOk=false}}else{if(newStatus=="STATUS_FAILED"||newStatus=="STATUS_UNDEFINED"){propagateStatusToChildren(task,newStatus,false);propagateStatusToInferiors(task.getInferiors(),newStatus)}}}}}if(!todoOk){task.status=oldStatus}return todoOk}function propagateStatusToInferiors(infs,status){for(var i=0;i<infs.length;i++){propagateStatus(infs[i].to,status,false,false,false)}}function propagateStatusToChildren(task,newStatus,skipClosedTasks){var chds=task.getChildren();for(var i=0;i<chds.length;i++){if(!(skipClosedTasks&&chds[i].status=="STATUS_DONE")){propagateStatus(chds[i],newStatus,false,true,false)}}}var manuallyChanged=true;var oldStatus=this.status;if(propagateStatus(this,newStatus,manuallyChanged,false,false)){return true}else{this.status=oldStatus;return false}};Task.prototype.synchronizeStatus=function(){var oldS=this.status;this.status=this.getParent()?this.getParent().status:"STATUS_UNDEFINED";return this.changeStatus(oldS,true)};Task.prototype.isLocallyBlockedByDependencies=function(){var sups=this.getSuperiors();var blocked=false;for(var i=0;i<sups.length;i++){if(sups[i].from.status!="STATUS_DONE"){blocked=true;break}}return blocked};Task.prototype.getRow=function(){ret=-1;if(this.master){ret=this.master.tasks.indexOf(this)}return ret};Task.prototype.getParents=function(){var ret;if(this.master){var topLevel=this.level;var pos=this.getRow();ret=[];for(var i=pos;i>=0;i--){var par=this.master.tasks[i];if(topLevel>par.level){topLevel=par.level;ret.push(par)}}}return ret};Task.prototype.getParent=function(){var ret;if(this.master){for(var i=this.getRow();i>=0;i--){var par=this.master.tasks[i];if(this.level>par.level){ret=par;break}}}return ret};Task.prototype.isParent=function(){var ret=false;if(this.master){var pos=this.getRow();if(pos<this.master.tasks.length-1){ret=this.master.tasks[pos+1].level>this.level}}return ret};Task.prototype.getChildren=function(){var ret=[];if(this.master){var pos=this.getRow();for(var i=pos+1;i<this.master.tasks.length;i++){var ch=this.master.tasks[i];if(ch.level==this.level+1){ret.push(ch)}else{if(ch.level<=this.level){break}}}}return ret};Task.prototype.getDescendant=function(){var ret=[];if(this.master){var pos=this.getRow();for(var i=pos+1;i<this.master.tasks.length;i++){var ch=this.master.tasks[i];if(ch.level>this.level){ret.push(ch)}else{break}}}return ret};Task.prototype.getSuperiors=function(){var ret=[];var task=this;if(this.master){ret=this.master.links.filter(function(link){return link.to==task})}return ret};Task.prototype.getSuperiorTasks=function(){var ret=[];var sups=this.getSuperiors();for(var i=0;i<sups.length;i++){ret.push(sups[i].from)}return ret};Task.prototype.getInferiors=function(){var ret=[];var task=this;if(this.master){ret=this.master.links.filter(function(link){return link.from==task})}return ret};Task.prototype.getInferiorTasks=function(){var ret=[];var infs=this.getInferiors();for(var i=0;i<infs.length;i++){ret.push(infs[i].to)}return ret};Task.prototype.deleteTask=function(){if(this.master.currentTask&&this.master.currentTask.id==this.id){delete this.master.currentTask}if(this.rowElement){this.rowElement.remove()}if(this.ganttElement){this.ganttElement.remove()}var chd=this.getChildren();for(var i=0;i<chd.length;i++){chd[i].deleteTask()}if(!this.isNew()){this.master.deletedTaskIds.push(this.id)}this.master.tasks.splice(this.getRow(),1);var task=this;this.master.links=this.master.links.filter(function(link){return link.from!=task&&link.to!=task})};Task.prototype.isNew=function(){return(this.id+"").indexOf("tmp_")==0};Task.prototype.isDependent=function(t){var task=this;var dep=this.master.links.filter(function(link){return link.from==task});for(var i=0;i<dep.length;i++){if(dep[i].to==t){return true}}for(var i=0;i<dep.length;i++){if(dep[i].to.isDependent(t)){return true}}return false};Task.prototype.setLatest=function(maxCost){this.latestStart=maxCost-this.criticalCost;this.latestFinish=this.latestStart+this.duration};Task.prototype.indent=function(){var row=this.getRow();if(row<=0){return false}var ret=false;var taskAbove=this.master.tasks[row-1];var newLev=this.level+1;if(newLev<=taskAbove.level+1){ret=true;this.level++;var futureParents=this.getParents();this.level--;var oldLevel=this.level;for(var i=row;i<this.master.tasks.length;i++){var desc=this.master.tasks[i];if(desc.level>oldLevel||desc==this){desc.level++;this.master.links=this.master.links.filter(function(link){var linkToParent=false;if(link.to==desc){linkToParent=futureParents.indexOf(link.from)>=0}else{if(link.from==desc){linkToParent=futureParents.indexOf(link.to)>=0}}return !linkToParent});var predecessorsOfFutureParents=[];for(var j=0;j<futureParents.length;j++){predecessorsOfFutureParents=predecessorsOfFutureParents.concat(futureParents[j].getSuperiorTasks())}this.master.links=this.master.links.filter(function(link){var linkToParent=false;if(link.from==desc){linkToParent=predecessorsOfFutureParents.indexOf(link.to)>=0}return !linkToParent})}else{break}}var parent=this.getParent();
  if(parent&&!this.depends){var new_end=computeEndByDuration(parent.start,this.duration);this.master.changeTaskDates(this,parent.start,new_end)}this.master.updateDependsStrings();updateTree(this);this.getParent().synchronizeStatus()}return ret};Task.prototype.outdent=function(){if(this.level<=1){return false}var ret=false;var oldLevel=this.level;ret=true;var row=this.getRow();for(var i=row;i<this.master.tasks.length;i++){var desc=this.master.tasks[i];if(desc.level>oldLevel||desc==this){desc.level--}else{break}}var task=this;var chds=this.getChildren();this.master.links=this.master.links.filter(function(link){var linkExist=(link.to==task&&chds.indexOf(link.from)>=0||link.from==task&&chds.indexOf(link.to)>=0);return !linkExist});for(var i=0;i<chds.length;i++){chds[i].setPeriod(chds[i].start+1,chds[i].end+1)}this.master.updateDependsStrings();this.setPeriod(this.start+1,this.end+1);this.synchronizeStatus();return ret};Task.prototype.moveUp=function(){var ret=false;var row=this.getRow();if(row<=0){return false}var newRow;for(newRow=row-1;newRow>=0;newRow--){if(this.master.tasks[newRow].level<=this.level){break}}if(this.master.tasks[newRow].level==this.level){ret=true;var descNumber=0;for(var i=row+1;i<this.master.tasks.length;i++){var desc=this.master.tasks[i];if(desc.level>this.level){descNumber++}else{break}}var blockToMove=this.master.tasks.splice(row,descNumber+1);var top=this.master.tasks.splice(0,newRow);this.master.tasks=[].concat(top,blockToMove,this.master.tasks);var rows=this.master.editor.element.find("tr[taskid]");var domBlockToMove=rows.slice(row,row+descNumber+1);rows.eq(newRow).before(domBlockToMove);this.master.updateDependsStrings()}else{this.master.setErrorOnTransaction(GanttMaster.messages["TASK_MOVE_INCONSISTENT_LEVEL"],this);ret=false}return ret};Task.prototype.moveDown=function(){var row=this.getRow();if(row>=this.master.tasks.length-1||row==0){return false}var ret=false;var newRow;for(newRow=row+1;newRow<this.master.tasks.length;newRow++){if(this.master.tasks[newRow].level<=this.level){break}}if(this.master.tasks[newRow]&&this.master.tasks[newRow].level==this.level){ret=true;for(newRow=newRow+1;newRow<this.master.tasks.length;newRow++){if(this.master.tasks[newRow].level<=this.level){break}}var descNumber=0;for(var i=row+1;i<this.master.tasks.length;i++){var desc=this.master.tasks[i];if(desc.level>this.level){descNumber++}else{break}}var blockToMove=this.master.tasks.splice(row,descNumber+1);var top=this.master.tasks.splice(0,newRow-descNumber-1);this.master.tasks=[].concat(top,blockToMove,this.master.tasks);var rows=this.master.editor.element.find("tr[taskid]");var aft=rows.eq(newRow-1);var domBlockToMove=rows.slice(row,row+descNumber+1);aft.after(domBlockToMove);this.master.updateDependsStrings()}return ret};Task.prototype.canStatusBeChangedTo=function(newStatus){if(newStatus==this.status){return true}var parent=this.getParent();if("STATUS_DONE"==newStatus){if(!parent){return true}if("STATUS_FAILED"==parent.status||"STATUS_UNDEFINED"==parent.status){return false}var sups=this.getSuperiorTasks();for(var i=0;i<sups.length;i++){if("STATUS_DONE"!=sups[i].status){return false}}return true}else{if("STATUS_ACTIVE"==newStatus){if(!parent){return true}if(!"STATUS_ACTIVE"==parent.status){return false}var sups=this.getSuperiorTasks();for(var i=0;i<sups.length;i++){if("STATUS_DONE"!=sups[i].status){return false}}return true}else{if("STATUS_WAITING"==newStatus){if(!parent){return false}if("STATUS_FAILED"==parent.status||"STATUS_UNDEFINED"==parent.status){return false}if("STATUS_WAITING"==parent.status){return true}var sups=this.getSuperiorTasks();for(var i=0;i<sups.length;i++){if("STATUS_WAITING"==sups[i].status||"STATUS_ACTIVE"==sups[i].status){return true}}return false}else{if("STATUS_SUSPENDED"==newStatus){if(!parent){return true}if("STATUS_UNDEFINED"==parent.status||"STATUS_FAILED"==parent.status){return false}return true}else{if("STATUS_FAILED"==newStatus){return true}else{if("STATUS_UNDEFINED"==newStatus){return true}}}}}}return false};function Link(taskFrom,taskTo,lagInWorkingDays){this.from=taskFrom;this.to=taskTo;this.lag=lagInWorkingDays}function Assignment(id,resourceId,roleId,effort){this.id=id;this.resourceId=resourceId;this.roleId=roleId;this.effort=effort}function Resource(id,name){this.id=id;this.name=name}function Role(id,name){this.id=id;this.name=name};